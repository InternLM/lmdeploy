# W4A16 LLM 模型部署

LMDeploy 支持 4bit 权重模型的推理，**对 NVIDIA 显卡的最低要求是 sm80**。

在推理之前，请确保安装了 lmdeploy，版本 >= v0.0.4

```shell
pip install lmdeploy
```

## 4bit 权重模型推理

你可以直接从 LMDeploy 的 [model zoo](https://huggingface.co/lmdeploy) 下载已经量化好的 4bit 权重模型，直接使用下面的命令推理。也可以根据["4bit 权重量化"](<>)章节的内容，把 FP16 权重量化为 4bit 权重，然后再按下述说明推理

以 4bit 的 internlm-chat-7b 模型为例，首先

```shell
## 安装
pip install lmdeploy

## 下载模型
git-lfs install
git clone https://huggingface.co/lmdeploy/internlm-chat-7b-w4

## 转换模型的layout，存放在默认路径 ./workspace 下
python3 -m lmdeploy.serve.turbomind.deploy \
    --model-name internlm-chat-7b \
    --model-path ./internlm-chat-7b-w4 \
    --model-format awq \
    --group-size 128

## 推理
python3 -m lmdeploy.turbomind.chat ./workspace

```

## 4bit 权重量化

4bit 权重量化包括 2 步：

- 生成量化参数
- 根据量化参数，量化模型权重

以下为详细的命令：

### 第一步：生成量化参数

```shell
python3 -m lmdeploy.lite.apis.calibrate \
  --model $HF_MODEL \
  --calib_dataset 'c4' \             # 校准数据集，支持 c4, ptb, wikitext2, pileval
  --calib_samples 128 \              # 校准集的样本数，如果显存不够，可以适当调小
  --calib_seqlen 2048 \              # 单条的文本长度，如果显存不够，可以适当调小
  --work_dir $WORK_DIR \             # 保存 Pytorch 格式量化统计参数和量化后权重的文件夹
```

### 第二步：量化权重模型

LMDeploy 使用 AWQ 算法对模型权重进行量化。在执行下面的命令时，需要把步骤1的`$WORK_DIR`传入。量化结束后，权重文件也会存放在这个目录中。然后就可以根据 ["4bit权重模型推理"](<>)章节的说明，进行模型推理。

```shell
python3 -m lmdeploy.lite.apis.auto_awq \
  --w_bits 4 \                       # 权重量化的 bit 数
  --w_group_size 128 \               # 权重量化分组统计尺寸
  --work_dir $WORK_DIR \             # Step 1 保存量化参数的目录
```
