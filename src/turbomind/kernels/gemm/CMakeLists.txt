# Copyright (c) OpenMMLab. All rights reserved.

FetchContent_Declare(
  repo-nvbench
  GIT_REPOSITORY https://github.com/NVIDIA/nvbench.git
  GIT_TAG        d8dced8a64d9ce305add92fa6d274fd49b569b7e
)

set(BUILD_SHARED_LIBS OFF)
set(NVBench_ENABLE_EXAMPLES OFF)

FetchContent_MakeAvailable(repo-nvbench)

add_library(gemm2
        gemm.cu
        kernel.cu
        # transcript.cu
        dispatch_cache.cu
        cache_utils.cu
        gpu_metric.cu
        convert_v2.cu
        # codegen/sm80_s16816gemm_f16_f16_nn.cu
        codegen/sm80_s16816gemm_f16_f16_nn_pack.cu
        # codegen/sm70_sgemm_f16_f16_f16_tn.cu
        # codegen/sm70_s884gemm_f16_f16_f16_tn.cu
        quantization.cu
        cast.cu
        # tmp.cu
        )

        # codegen/gemm_sm80_f16_u4_f16_asym_g128_basic.cu
        # codegen/gemm_sm80_f16_u4_f16_asym_g128_extra.cu
        # codegen/gemm_sm80_f16_f16_f16.cu
        # codegen/sm80_s16816gemm_f16_f16.cu
        # codegen/sm70_s884gemm_f16_f16.cu

add_executable(gemm_bench gemm_bench.cu test_utils.cu cache_utils.cu)
target_link_libraries(gemm_bench PRIVATE gemm2 nvbench::nvbench cublas)

target_compile_options(gemm2 PRIVATE
        $<$<COMPILE_LANGUAGE:CUDA>:-Xptxas=-v --generate-line-info>)
set_property(TARGET gemm2 PROPERTY POSITION_INDEPENDENT_CODE ON)
set_property(TARGET gemm2 PROPERTY CUDA_RESOLVE_DEVICE_SYMBOLS ON)

add_executable(gemm_test gemm_test.cu test_utils.cu cache_utils.cu reference.cu)
target_link_libraries(gemm_test PRIVATE gemm2 cublas)
